---
phase: 03-correlation
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/agents/correlator_agent.py
  - src/storage/cosmos.py
  - tests/test_correlator_smoke.py
autonomous: true
must_haves:
  truths:
    - "Correlator Agent can read threats, run vector similarity, and write correlation links"
    - "Correlations persist in Cosmos and can be fetched for reporting"
  artifacts:
    - path: "src/agents/correlator_agent.py"
      provides: "Batch correlator agent orchestration"
  key_links:
    - from: "src/agents/correlator_agent.py"
      to: "src/storage/search.py"
      via: "vector query"
      pattern: "vector"
    - from: "src/agents/correlator_agent.py"
      to: "src/storage/cosmos.py"
      via: "upsert correlations"
      pattern: "correlation"
---

<objective>
Implement the Correlator Agent to generate embeddings, run vector search, and persist correlation links.

Purpose: Demonstrate multi-source correlation (the "hard" part that wins the hackathon pitch).
Output: Correlator agent + storage wiring.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
  @.planning/REQUIREMENTS.md
  @.planning/phases/03-correlation/03-01-SUMMARY.md
  @.planning/phases/03-correlation/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Cosmos store with correlation upsert/query helpers</name>
  <files>src/storage/cosmos.py</files>
  <action>
Extend `CosmosStore`:
- Add `upsert_correlation(link: dict) -> dict` targeting the correlations container
- Add `list_recent_threats(limit: int = 200) -> list[dict]` (simple query by time if available, otherwise by _ts)
- Add `list_correlations_for_threat(threat_id: str) -> list[dict]`

Keep APIs minimal and consistent with threat upsert.
  </action>
  <verify>python3 -c "from storage.cosmos import CosmosStore; hasattr(CosmosStore, 'upsert_correlation')"</verify>
  <done>CosmosStore supports correlation persistence</done>
</task>

<task type="auto">
  <name>Task 2: Implement Correlator Agent (read -> index -> search -> link -> store)</name>
  <files>src/agents/correlator_agent.py</files>
  <action>
Create `src/agents/correlator_agent.py` with `run_correlation()`:
- Load recent threats from Cosmos
- Convert to `UnifiedThreat`
- Index threats into AI Search using `SearchStore.index_threats`
- For each threat, run a vector similarity query via `SearchStore.vector_query(...)` (topK ~ 5-10, excluding same id)
- Convert hits into `CorrelationLink` objects via matcher
- Upsert correlations into Cosmos

Return stats: {threats_indexed, queries, links_created, stored, errors}.
  </action>
  <verify>python3 -c "from agents.correlator_agent import run_correlation"</verify>
  <done>Correlator agent entrypoint is importable</done>
</task>

<task type="auto">
  <name>Task 3: Add correlator smoke test (no live Azure calls)</name>
  <files>tests/test_correlator_smoke.py</files>
  <action>
Add a smoke test that imports correlator modules and runs the matcher/scoring on a small in-memory fixture without touching Azure.
  </action>
  <verify>python3 -m pytest -q</verify>
  <done>Smoke test passes</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
- (Live, optional) With Azure env vars set: run collection agents then `run_correlation()` and confirm correlations container is populated
</verification>

<success_criteria>
- Correlator can produce at least one meaningful link in the demo dataset
</success_criteria>

<output>
After completion, create `.planning/phases/03-correlation/03-03-SUMMARY.md`
</output>
