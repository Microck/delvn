---
phase: 02-collection-agents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agents/__init__.py
  - src/integrations/__init__.py
  - src/models/unified_threat.py
  - src/normalization/__init__.py
  - src/normalization/normalize.py
  - tests/test_normalization.py
autonomous: true
must_haves:
  truths:
    - "All collectors output the same unified threat shape"
    - "Normalization preserves source identity while standardizing core fields"
  artifacts:
    - path: "src/models/unified_threat.py"
      provides: "Unified threat representation used by all agents"
    - path: "src/normalization/normalize.py"
      provides: "Normalization helpers (source-specific to unified)"
    - path: "tests/test_normalization.py"
      provides: "Examples ensuring stable normalized outputs"
  key_links:
    - from: "src/normalization/normalize.py"
      to: "src/models/unified_threat.py"
      via: "UnifiedThreat construction"
      pattern: "UnifiedThreat"
---

<objective>
Create the unified threat format and normalization layer used by all collector agents.

Purpose: Enable correlation/prioritization to work across sources without per-source branching.
Output: Unified model + normalizers + tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
  @.planning/ROADMAP.md
  @.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement UnifiedThreat model</name>
  <files>src/models/unified_threat.py</files>
  <action>
  Create `src/models/unified_threat.py` with a `UnifiedThreat` Pydantic model.

  Guidance:
  - Unify on a single shape used by all collectors:
  - identity: `id`, `source`, `type`
  - human fields: `title`, `summary`
  - time: `published_at`, `observed_at`
  - severity: `severity` (0..10 optional)
  - IOCs: `indicators` (list of {type, value})
  - tags + references
  - `raw` payload

Add helpers:
- `UnifiedThreat.content_text()` returning the text that should be embedded/searched.
  </action>
  <verify>python3 -c "from models.unified_threat import UnifiedThreat; UnifiedThreat.model_json_schema()"</verify>
  <done>UnifiedThreat imports and has `content_text()`</done>
</task>

<task type="auto">
  <name>Task 2: Create normalization helpers</name>
  <files>
src/agents/__init__.py
src/integrations/__init__.py
 src/normalization/__init__.py
 src/normalization/normalize.py
  </files>
  <action>
Create `src/agents/__init__.py` and `src/integrations/__init__.py` as minimal packages so later agent/integration modules import cleanly.

Create `src/normalization/normalize.py` with pure functions:
- `normalize_nvd_cve(payload: dict) -> UnifiedThreat`
- `normalize_otx_indicator(payload: dict) -> UnifiedThreat`
- `normalize_rss_item(payload: dict) -> UnifiedThreat`

Keep these functions deterministic and side-effect free; storage happens in agents.
  </action>
  <verify>python3 -c "import agents, integrations; from normalization.normalize import normalize_nvd_cve"</verify>
  <done>Normalizers exist and return `UnifiedThreat`</done>
</task>

<task type="auto">
  <name>Task 3: Add normalization tests with representative samples</name>
  <files>tests/test_normalization.py</files>
  <action>
Add tests that feed minimal representative payloads into each normalizer and assert:
- `id/source/type` stable
- `title` non-empty
- `content_text()` contains key terms (e.g., CVE id, indicator value)
  </action>
  <verify>python3 -m pytest -q</verify>
  <done>Normalization tests pass</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
</verification>

<success_criteria>
- All collectors can emit `UnifiedThreat` objects without ad-hoc per-agent schemas
</success_criteria>

<output>
After completion, create `.planning/phases/02-collection-agents/02-01-SUMMARY.md`
</output>
