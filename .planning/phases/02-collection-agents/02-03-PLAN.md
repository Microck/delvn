---
phase: 02-collection-agents
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/integrations/otx.py
  - src/agents/intel_agent.py
  - tests/test_otx_normalization.py
autonomous: true
user_setup:
  - service: alienvault-otx
    why: "Threat intel collection from AlienVault OTX API"
    env_vars:
      - name: OTX_API_KEY
        source: "AlienVault OTX profile -> API key"
must_haves:
  truths:
    - "Intel Agent can pull indicators from OTX"
    - "Indicators normalize into UnifiedThreat with stable id/type/value"
  artifacts:
    - path: "src/integrations/otx.py"
      provides: "OTX API client + indicator extraction"
    - path: "src/agents/intel_agent.py"
      provides: "Intel collector agent (OTX -> UnifiedThreat -> storage)"
  key_links:
    - from: "src/agents/intel_agent.py"
      to: "src/integrations/otx.py"
      via: "fetch_recent_indicators"
      pattern: "otx\."
---

<objective>
Implement the Intel Agent to collect threat indicators from AlienVault OTX and normalize them.

Purpose: Provide active-intel signal that can correlate to CVEs and campaigns.
Output: OTX integration client, Intel agent, normalization tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
  @.planning/REQUIREMENTS.md
  @.planning/phases/02-collection-agents/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OTX integration client</name>
  <files>src/integrations/otx.py</files>
  <action>
Create `src/integrations/otx.py`:
- Use `common.http.get_json`
- Include `X-OTX-API-KEY` header when `OTX_API_KEY` present
- Implement `fetch_recent_indicators(limit: int = 50) -> list[dict]`

Keep the payload returned close to what `normalize_otx_indicator` expects (raw-ish dicts).
  </action>
  <verify>python3 -c "from integrations.otx import fetch_recent_indicators"</verify>
  <done>OTX client is importable and has fetch function</done>
</task>

<task type="auto">
  <name>Task 2: Implement Intel Agent (collect -> normalize -> store)</name>
  <files>src/agents/intel_agent.py</files>
  <action>
Create `src/agents/intel_agent.py` with `run_intel_collection()`:
- Fetch OTX indicators
- Normalize each via `normalize_otx_indicator`
- Upsert into Cosmos

Return stats: {fetched, normalized, stored, errors}.
  </action>
  <verify>python3 -c "from agents.intel_agent import run_intel_collection"</verify>
  <done>Intel agent entrypoint is importable</done>
</task>

<task type="auto">
  <name>Task 3: Add OTX normalization tests for indicator types</name>
  <files>tests/test_otx_normalization.py</files>
  <action>
Add tests for representative indicator payloads:
- ip
- domain
- url

Assert normalized object includes `{type, value}` in indicators and a stable id prefix.
  </action>
  <verify>python3 -m pytest -q</verify>
  <done>OTX tests pass</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
</verification>

<success_criteria>
- Intel Agent can populate Cosmos with OTX-derived `UnifiedThreat` documents
</success_criteria>

<output>
After completion, create `.planning/phases/02-collection-agents/02-03-SUMMARY.md`
</output>
