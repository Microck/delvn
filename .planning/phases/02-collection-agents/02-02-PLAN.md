---
phase: 02-collection-agents
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/integrations/nvd.py
  - src/agents/cve_agent.py
  - tests/test_nvd_parsing.py
autonomous: true
user_setup:
  - service: nvd
    why: "CVE collection from NVD API (rate limits improve with key)"
    env_vars:
      - name: NVD_API_KEY
        source: "NVD API key portal"
must_haves:
  truths:
    - "CVE Agent can fetch recent CVEs from NVD"
    - "CVSS score + description are parsed into UnifiedThreat"
  artifacts:
    - path: "src/integrations/nvd.py"
      provides: "NVD API client + response parsing"
    - path: "src/agents/cve_agent.py"
      provides: "CVE collector agent (NVD -> UnifiedThreat -> storage)"
  key_links:
    - from: "src/agents/cve_agent.py"
      to: "src/integrations/nvd.py"
      via: "fetch_recent_cves"
      pattern: "nvd\."
    - from: "src/agents/cve_agent.py"
      to: "src/storage/cosmos.py"
      via: "upsert"
      pattern: "Cosmos"
---

<objective>
Implement the CVE Agent to collect from the NVD API and normalize into the unified threat model.

Purpose: Provide high-signal vulnerability data as one of the three MVP sources.
Output: NVD integration client, CVE agent, tests for parsing.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
  @.planning/REQUIREMENTS.md
  @.planning/phases/02-collection-agents/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NVD integration client</name>
  <files>
src/integrations/nvd.py
  </files>
  <action>
Create `src/integrations/nvd.py`:
- Use `common.http.get_json` for requests
- Implement `fetch_recent_cves(*, pub_start: datetime | None = None, results_per_page: int = 50) -> list[dict]`
- Parse the NVD response into minimal CVE payloads expected by `normalize_nvd_cve`

Handle:
- pagination via `startIndex`
- optional API key header if `NVD_API_KEY` present
  </action>
  <verify>python3 -c "from integrations.nvd import fetch_recent_cves"</verify>
  <done>NVD client module imports and exposes `fetch_recent_cves`</done>
</task>

<task type="auto">
  <name>Task 2: Implement CVE Agent (collect -> normalize -> store)</name>
  <files>
src/agents/cve_agent.py
  </files>
  <action>
Create `src/agents/cve_agent.py` implementing a single entrypoint like `run_cve_collection()`:
- Fetch CVEs from NVD
- Normalize each CVE via `normalize_nvd_cve`
- Upsert into Cosmos threats container using `storage.cosmos.CosmosStore`

Keep it batch-oriented (no streaming, no realtime).
Return a small stats object: {fetched, normalized, stored, errors}.
  </action>
  <verify>python3 -c "from agents.cve_agent import run_cve_collection"</verify>
  <done>CVE agent entrypoint is importable</done>
</task>

<task type="auto">
  <name>Task 3: Add parsing tests for CVSS + description extraction</name>
  <files>tests/test_nvd_parsing.py</files>
  <action>
Add tests using a small embedded NVD-like fixture dict:
- Extract CVE id, description
- Extract a numeric severity (0..10) when present
- Ensure the normalized `UnifiedThreat.content_text()` contains the CVE id
  </action>
  <verify>python3 -m pytest -q</verify>
  <done>NVD parsing tests pass</done>
</task>

</tasks>

<verification>
- `python3 -m pytest -q` passes
- (Optional live check) `python3 -c "from agents.cve_agent import run_cve_collection; print(run_cve_collection())"` with env vars set
</verification>

<success_criteria>
- CVE Agent can populate Cosmos with recent CVE-derived `UnifiedThreat` documents
</success_criteria>

<output>
After completion, create `.planning/phases/02-collection-agents/02-02-SUMMARY.md`
</output>
